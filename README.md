# Go WASM Shared Worker

A multi-tab communication system using Go compiled to WebAssembly with JavaScript Shared Workers. Allows different browser tabs to subscribe to channels and receive updates through a central shared worker.

## Features

- **Multi-tab communication**: Tabs connect to a shared worker that runs once across the entire browser session
- **Pub/Sub model**: Publish data to channels, subscribe to receive updates
- **Persistent state**: Worker maintains data for each channel; new subscribers receive current data
- **Type-safe Go backend**: Business logic runs in Go compiled to WASM
- **Promise-based API**: Modern async/await client library

## Architecture

```
Browser Tab 1 ──┐
                ├──> Shared Worker (Go WASM) ──┐
Browser Tab 2 ──┤                               ├──> Subscriptions
                │                               │    Data Store
Browser Tab 3 ──┘                               │
                                                ├──> MessagePort Communication
                                                │
                                         (worker.wasm)
```

## Building

```bash
./build.sh
```

This compiles `main.go` to `worker.wasm` and copies the WASM runtime helper.

## File Structure

- **main.go** - Go shared worker implementation with pub/sub logic
- **worker.js** - Shared worker entry point that loads the WASM module
- **client.js** - Client library for connecting to the shared worker (ESM)
- **example.html** - Demo page showing multi-tab communication
- **wasm_exec.js** - Go WASM runtime (generated by build script)
- **worker.wasm** - Compiled Go binary (generated by build script)

## Usage

### Basic Setup

1. Build the project:
   ```bash
   ./build.sh
   ```

2. Start a web server:
   ```bash
   python3 -m http.server 8000
   ```

3. Open the example:
   ```
   http://localhost:8000/example.html
   ```

### In Your Application

```javascript
import { SharedWorkerClient } from './client.js';

// Create a client instance
const client = new SharedWorkerClient('./worker.js');

// Subscribe to a channel
const unsubscribe = client.subscribe('user-data', (data) => {
  console.log('Received:', data);
});

// Publish data
client.publish('user-data', { name: 'John', id: 123 });

// Get current data
const data = await client.get('user-data');
console.log('Current:', data);

// Unsubscribe
unsubscribe();
```

## API Reference

### SharedWorkerClient

#### `subscribe(channel, callback) -> Function`
Subscribe to a channel. Callback is called whenever data is published to the channel.
Returns an unsubscribe function.

```javascript
const unsubscribe = client.subscribe('prices', (data) => {
  console.log('New price:', data);
});

unsubscribe(); // Stop listening
```

#### `publish(channel, data)`
Publish data to a channel. All subscribers receive the data.

```javascript
client.publish('prices', { BTC: 45000, ETH: 2500 });
```

#### `get(channel) -> Promise`
Get current data for a channel.

```javascript
const currentData = await client.get('prices');
```

#### `unsubscribe(channel)`
Unsubscribe from a channel.

```javascript
client.unsubscribe('prices');
```

#### `disconnect()`
Close the connection to the shared worker.

```javascript
client.disconnect();
```

## Go Backend

The Go code runs in the shared worker and handles:

- **Message routing**: Processes subscribe/publish/get requests
- **Subscription management**: Tracks which clients are subscribed to which channels
- **Data storage**: Maintains the latest data for each channel
- **Broadcasting**: Sends updates to all interested clients
- **Port communication**: Uses MessagePort for client communication

### Message Protocol

All messages are JSON-encoded:

```typescript
// Request
{
  type: "subscribe" | "unsubscribe" | "publish" | "get",
  clientId: string,
  channel: string,
  data?: any,           // For publish requests
  requestId: number
}

// Response
{
  type: "data" | "subscribed" | "unsubscribed" | "published" | "error",
  channel?: string,
  data?: any,
  error?: string,
  requestId: number
}
```

## Performance Considerations

- **Single shared worker instance**: Reduces memory usage across tabs
- **Efficient subscriptions**: Clients only receive data for channels they care about
- **No polling**: Event-driven updates via message ports
- **WASM execution**: Go logic runs at near-native speed

## Limitations

- Shared Workers are not available in all browsers (check caniuse.com)
- No persistence across browser sessions (data is lost on refresh)
- Each browser context (private window, different domain) has its own shared worker
- Communication is in-process only (no cross-origin communication)

## Advanced: Adding Persistence

To persist data across sessions, extend the Go code to use IndexedDB via syscall/js:

```go
func (sw *SharedWorker) LoadFromDB(channel string) {
  // Use js.Global() to call IndexedDB APIs
}

func (sw *SharedWorker) SaveToDB(channel string, data json.RawMessage) {
  // Store data in IndexedDB
}
```

## License

MIT
